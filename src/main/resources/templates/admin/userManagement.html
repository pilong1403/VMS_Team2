<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</title>
    <link rel="stylesheet" th:href="@{/css/styleUser.css}" />
</head>
<body data-page="users">
<!-- Global Error Popup -->
<div th:if="${errorMessage}" id="errorPopup" class="error-popup">
    <div class="error-content">
        <strong>‚ö† L·ªói!</strong>
        <p th:text="${errorMessage}"></p>
    </div>
</div>
<!-- Popup b√°o th√†nh c√¥ng -->
<div th:if="${successMessage}" id="successPopup" class="success-popup">
    <div class="success-content">
        <strong>‚úÖ Th√†nh c√¥ng!</strong>
        <p th:text="${successMessage}"></p>
    </div>
</div>
<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-logo">
            <div class="logo-icon">üë•</div>
            <div class="logo-text">
                <h2>Qu·∫£n L√Ω Admin</h2><p>H·ªá th·ªëng qu·∫£n tr·ªã</p>
            </div>
        </div>
    </div>
    <nav class="sidebar-nav">
        <div class="nav-label">MENU CH√çNH</div>
        <ul class="nav-menu">
            <li><a th:href="@{/admin/users}" class="nav-item active">Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</a></li>
            <li><a th:href="@{/admin/organizations}" class="nav-item">H·ªì s∆° t·ªï ch·ª©c</a></li>
            <li><a th:href="@{/admin/reports}" class="nav-item">B√°o c√°o</a></li>
        </ul>
    </nav>
</aside>

<div class="main-wrapper">
    <header class="header">
        <button class="sidebar-toggle" id="sidebarToggle">‚ò∞</button>
        <div class="header-title">H·ªá th·ªëng Qu·∫£n l√Ω T√¨nh nguy·ªán</div>
    </header>

    <main class="content">
        <div class="page-header-actions">
            <div class="page-header">
                <h1>Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</h1>
                <p>T·ªïng s·ªë: <span id="totalUsers" th:text="${totalUsers}">0</span> ng∆∞·ªùi d√πng</p>
            </div>
            <button class="btn btn-primary" id="btnOpenAddUser">+ Th√™m Ng∆∞·ªùi D√πng</button>
        </div>

        <!-- Thanh t√¨m ki·∫øm & L·ªçc -->
        <div class="search-filter-bar">
            <div class="search-wrapper">
                <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                </svg>
                <input type="search" id="searchInput" placeholder="T√¨m theo t√™n, email, s·ªë ƒëi·ªán tho·∫°i..." />
            </div>
            <div class="filter-group">
                <select id="roleFilter">
                    <option value="admin">Qu·∫£n L√Ω</option>
                    <option value="volunteer">T·ªï Ch·ª©c</option>
                    <option value="organization">T√¨nh nguy·ªán vi√™n</option>
                    <option value="all" selected>T·∫•t c·∫£ vai tr√≤</option>
                </select>

                <select id="statusFilter">
                    <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                    <option value="ACTIVE">Ho·∫°t ƒë·ªông</option>
                    <option value="LOCKED">B·ªã kh√≥a</option>
                </select>
                <input type="date" id="userFromDate" />
                <input type="date" id="userToDate" />
                <button class="btn btn-outline" id="userDateFilterBtn">L·ªçc ng√†y</button>
            </div>
        </div>

        <!-- B·∫£ng -->
        <div class="table-wrapper">
            <table>
                <thead>
                <tr>
                    <th style="width:60px">Avatar</th>
                    <th>H·ªç t√™n</th>
                    <th>Email</th>
                    <th>S·ªë ƒëi·ªán tho·∫°i</th>
                    <th>Vai tr√≤</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Ng√†y t·∫°o</th>
                    <th style="text-align:right">H√†nh ƒë·ªông</th>
                </tr>
                </thead>
                <tbody id="userTableBody">

                <tr th:each="u : ${users}">
                    <td>
                        <img class="avatar" th:src="${u.avatarUrl}"
                             alt="avatar" width="40" height="40"
                             th:attr="data-userid=${u.userId}"/>

                    </td>
                    <td th:text="${u.fullName}">T√™n</td>
                    <td th:text="${u.email}">Email</td>
                    <td th:text="${u.phone}">SƒêT</td>
                    <td th:text="${u.role.roleName}">Vai tr√≤</td>
                    <td>
                          <span th:classappend="${u.status=='ACTIVE' ? 'status-active':'status-locked'}"
                                th:text="${u.status}">Tr·∫°ng th√°i</span>
                    </td>
                    <td th:text="${#temporals.format(u.createdAt, 'yyyy-MM-dd')}">Ng√†y</td>
                    <td style="text-align:right">
                        <form th:action="@{'/admin/users/' + ${u.userId} + '/toggle-status'}" method="post" style="display:inline;">
                            <button class="btn btn-sm"
                                    th:text="${u.status=='ACTIVE' ? 'Kh√≥a' : 'M·ªü'}"></button>
                        </form>
                        <form th:action="@{'/admin/users/' + ${u.userId} + '/delete'}" method="post" style="display:inline;">
                            <button class="btn btn-sm btn-danger">X√≥a</button>
                        </form>
                    </td>
                </tr>

                </tbody>
            </table>
        </div>

        <!-- Ph√¢n trang -->
        <div class="pagination">
            <div class="pagination-info">
                <span>Hi·ªÉn th·ªã</span>
                <select id="pageSizeSelect">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
                <span id="paginationText">‚Äî</span>
            </div>
            <div class="pagination-buttons" id="paginationButtons"></div>


                <button class="btn" id="prevPage">¬´</button>
                <span id="pageNumbers"></span>
                <button class="btn" id="nextPage">¬ª</button>


        </div>

    </main>
</div>


  <!-- Modal: Th√™m ng∆∞·ªùi d√πng (tab Nh·∫≠p tay / T·∫£i h√†ng lo·∫°t) -->
  <div class="modal" id="addUserModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Th√™m ng∆∞·ªùi d√πng m·ªõi</h2>

          <button class="modal-close" data-close="addUserModal">√ó</button>
      </div>
      <div class="modal-body">
        <div class="tabs" id="addUserTabs">
          <button class="tab active" data-tab="manual">Nh·∫≠p tay</button>
          <button class="tab" data-tab="bulk">T·∫£i l√™n h√†ng lo·∫°t</button>
        </div>

        <!-- Nh·∫≠p tay -->
        <form th:action="@{/admin/users/create}" method="post" id="addUserForm" data-tab-panel="manual">
          <div class="form-grid">
            <div class="form-group"><label>H·ªç t√™n *</label><input id="fullName" name="fullName" required></div>
            <div class="form-group"><label>Email *</label><input id="email" type="email"  name="email" required></div>
            <div class="form-group"><label>M·∫≠t kh·∫©u *</label><input id="password" name="passwordHash" type="password" minlength="6" required></div>
            <div class="form-group"><label>S·ªë ƒëi·ªán tho·∫°i</label><input id="phone" name="phone" type="tel"></div>

            <div class="form-group"><label>Vai tr√≤ *</label>
                <select id="roleId" name="role.roleId" required>
                    <option value="">-- Ch·ªçn vai tr√≤ --</option>
                    <option th:each="r: ${roles}" th:value="${r.roleId}" th:text="${r.roleName}"></option>
                </select>
            </div>
              <div class="form-group">

                  <div class="avatar-upload">
                      <!-- ·∫¢nh preview -->
                      <img id="avatarPreview" src="/images/default.png" alt="Avatar m·∫∑c ƒë·ªãnh">

                      <!-- Input upload ·∫£nh -->
                      <input type="file" id="avatarFile" name="avatarFile" accept="image/*" style="display:none;">
                      <button type="button" class="btn btn-outline" id="btnChooseAvatar">Ch·ªçn ·∫£nh</button>
                      <label>Avatar (kh√¥ng b·∫Øt bu·ªôc)</label>
                      <!-- Gi·ªØ URL ·∫£nh m·∫∑c ƒë·ªãnh (ho·∫∑c ·∫£nh ƒë√£ upload) ƒë·ªÉ g·ª≠i v·ªÅ backend -->
                      <input type="hidden" id="avatarUrl" name="avatarUrl" value="/img/default-avatar.png">
                  </div>
              </div>
              <div class="form-group full-width">
                  <label>ƒê·ªãa ch·ªâ</label>
                  <div class="address-group">
                      <select id="citySelect" name="citySelect" required>
                          <option value="">-- Ch·ªçn T·ªânh/Th√†nh ph·ªë --</option>
                      </select>
                      <select id="districtSelect" name="districtSelect" disabled required>
                          <option value="">-- Ch·ªçn Qu·∫≠n/Huy·ªán --</option>
                      </select>
                      <select id="wardSelect" name="wardSelect" disabled required>
                          <option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>
                      </select>
                  </div>
              </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline" data-close="addUserModal">H·ªßy</button>
            <button type="submit" class="btn btn-primary">T·∫°o t√†i kho·∫£n</button>
          </div>
        </form>

        <!-- Bulk -->
        <div id="bulkUploadPanel" class="bulk-panel" data-tab-panel="bulk" style="display:none">
          <div class="note-box">
            <h4>Y√™u c·∫ßu file Excel</h4>
            <ul>
              <li>ƒê·ªãnh d·∫°ng: <strong>.xlsx</strong></li>
              <li>C·ªôt: <strong>Email, H·ªç t√™n, SƒêT, Vai tr√≤</strong></li>
              <li>Vai tr√≤ h·ª£p l·ªá: Admin / Qu·∫£n l√Ω / Nh√¢n vi√™n</li>
              <li>Email tr√πng s·∫Ω b·ªã b·ªè qua v√† b√°o c√°o</li>
              <li>T·ªëi ƒëa 1000 t√†i kho·∫£n/l·∫ßn</li>
            </ul>
            <a class="btn btn-outline" href="/admin/users/bulk/template" download>‚¨á T·∫£i m·∫´u Excel</a>
          </div>
          <div class="dropzone" id="bulkDropzone">
            <input type="file" id="bulkFile" accept=".xlsx" hidden />
            <div class="dz-icon">üìÑ</div>
            <p>K√©o th·∫£ file Excel v√†o ƒë√¢y ho·∫∑c</p>
            <button type="button" class="btn btn-primary" id="btnChooseBulk">Ch·ªçn file</button>
            <div id="bulkFilename" class="muted mt-8"></div>
          </div>
          <div class="modal-footer" style="padding-left:0">
            <button type="button" class="btn btn-outline" data-close="addUserModal">H·ªßy</button>
            <button type="button" class="btn btn-primary" id="btnUploadBulk" disabled>T·∫£i l√™n</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Chi ti·∫øt ng∆∞·ªùi d√πng + ƒê√°nh gi√° sao -->
  <div class="modal" id="userDetailModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Chi ti·∫øt ng∆∞·ªùi d√πng</h2>
        <button class="modal-close" data-close="userDetailModal">√ó</button>
      </div>
      <div class="modal-body" id="userDetailContent"></div>
    </div>
  </div>

<!-- Toast -->
<div class="toast" id="toast">
    <div class="toast-content">
        <strong id="toastTitle"></strong>
        <p id="toastMessage"></p>
    </div>
</div>

<script th:src="@{/js/jsUser.js}"></script>
</body>
</html>
