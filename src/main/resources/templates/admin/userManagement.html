<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</title>
    <link rel="stylesheet" th:href="@{/css/styleUser.css}"/>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
          integrity="sha512-...something..."
          crossorigin="anonymous" referrerpolicy="no-referrer"/>

</head>
<body data-page="users">
<!-- Global Error Popup -->
<div th:if="${errorMessage}" id="errorPopup" class="error-popup">
    <div class="error-content">
        <strong>‚ö† L·ªói!</strong>
        <p th:text="${errorMessage}"></p>
    </div>
</div>
<!-- Popup b√°o th√†nh c√¥ng -->
<div th:if="${successMessage}" id="successPopup" class="success-popup">
    <div class="success-content">
        <strong> Th√†nh c√¥ng!</strong>
        <p th:text="${successMessage}"></p>
    </div>
</div>
<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-logo">
            <div class="logo-icon">üë•</div>
            <div class="logo-text">
                <h2>Qu·∫£n L√Ω Admin</h2>
                <p>H·ªá th·ªëng qu·∫£n tr·ªã</p>
            </div>
        </div>
    </div>
    <nav class="sidebar-nav">
        <div class="nav-label">MENU CH√çNH</div>
        <ul class="nav-menu">
            <li><a th:href="@{/admin/users}" class="nav-item active">Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</a></li>
            <li><a th:href="@{/admin/organizations}" class="nav-item">H·ªì s∆° t·ªï ch·ª©c</a></li>
            <li><a th:href="@{/admin/reports}" class="nav-item">B√°o c√°o</a></li>
        </ul>
    </nav>
</aside>

<div class="main-wrapper">
    <header class="header">
        <button class="sidebar-toggle" id="sidebarToggle">‚ò∞</button>
        <div class="header-title">H·ªá th·ªëng Qu·∫£n l√Ω T√¨nh nguy·ªán</div>
    </header>

    <main class="content">
        <div class="page-header-actions">
            <div class="page-header">
                <h1>Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</h1>
                <p>T·ªïng s·ªë: <span id="totalUsers" th:text="${totalUsers}">0</span> ng∆∞·ªùi d√πng</p>
            </div>
            <button class="btn btn-primary" id="btnOpenAddUser">+ Th√™m Ng∆∞·ªùi D√πng</button>
        </div>

        <!-- üîß Thanh t√¨m ki·∫øm & L·ªçc -->
        <form class="search-filter-bar" th:action="@{/admin/users}" method="get">
            <div class="search-wrapper">
                <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
                <input type="search"
                       id="searchInput"
                       name="keyword"
                       placeholder="T√¨m theo t√™n, email, s·ªë ƒëi·ªán tho·∫°i..."
                       th:value="${keyword}"/>
            </div>

            <div class="filter-group">
                <!-- Vai tr√≤ -->
                <select id="roleFilter" name="roleId">
                    <option value="" th:selected="${roleId == null}">T·∫•t c·∫£ vai tr√≤</option>
                    <option th:each="r : ${roles}"
                            th:value="${r.roleId}"
                            th:text="${r.roleName}"
                            th:selected="${roleId != null and roleId == r.roleId}">
                    </option>
                </select>

                <!-- Tr·∫°ng th√°i -->
                <select id="statusFilter" name="status">
                    <option value="" th:selected="${status == null}">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                    <option th:value="'ACTIVE'"
                            th:selected="${status == T(com.fptuni.vms.model.User.UserStatus).ACTIVE}">Ho·∫°t ƒë·ªông
                    </option>
                    <option th:value="'LOCKED'"
                            th:selected="${status == T(com.fptuni.vms.model.User.UserStatus).LOCKED}">B·ªã kh√≥a
                    </option>
                </select>

                <!-- Kho·∫£ng ng√†y -->
                <input type="date" id="userFromDate" name="fromDate" th:value="${fromDate}">
                <input type="date" id="userToDate" name="toDate" th:value="${toDate}">

                <!-- Gi·ªØ k√≠ch th∆∞·ªõc trang -->
                <input type="hidden" name="size" th:value="${size}">
                <input type="hidden" name="page" value="0">

                <button class="btn btn-outline" type="submit">L·ªçc</button>
            </div>
        </form>
        <!-- B·∫£ng -->
        <div class="table-wrapper">
            <table>
                <thead>
                <tr>
                    <th style="width:60px">Avatar</th>
                    <th>H·ªç t√™n
                        <span class="sort-icons">
        <a th:href="@{/admin/users(
        sortField='fullName',
        sortDir='ASC',
        keyword=${keyword},
        roleId=${roleId},
        status=${status},
        fromDate=${fromDate},
        toDate=${toDate},
        page=0,
        size=${size}
    )}" class="sort-icon up" title="TƒÉng">‚ñ≤</a>

<a th:href="@{/admin/users(
        sortField='fullName',
        sortDir='DESC',
        keyword=${keyword},
        roleId=${roleId},
        status=${status},
        fromDate=${fromDate},
        toDate=${toDate},
        page=0,
        size=${size}
    )}" class="sort-icon down" title="Gi·∫£m">‚ñº</a>

    </span></th>
                    <th>Email</th>
                    <th>S·ªë ƒëi·ªán tho·∫°i</th>
                    <th>Vai tr√≤</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Ng√†y t·∫°o
                        <span class="sort-icons">
       <a th:href="@{/admin/users(
        sortField='createdAt', sortDir='ASC',
        keyword=${keyword}, roleId=${roleId}, status=${status},
        fromDate=${fromDate}, toDate=${toDate}, page=0, size=${size}
    )}" class="sort-icon up" title="C≈© nh·∫•t">‚ñ≤</a>

<a th:href="@{/admin/users(
        sortField='createdAt', sortDir='DESC',
        keyword=${keyword}, roleId=${roleId}, status=${status},
        fromDate=${fromDate}, toDate=${toDate}, page=0, size=${size}
    )}" class="sort-icon down" title="M·ªõi nh·∫•t">‚ñº</a>
    </span></th>
                    <th style="text-align:right">H√†nh ƒë·ªông</th>
                </tr>
                </thead>
                <tbody id="userTableBody">

                <tr th:each="u : ${users}">
                    <td>
                        <a th:href="@{'/admin/users?viewUser=' + ${u.userId}}">
                            <img class="avatar"
                                 th:src="${u.avatarUrl != null ? u.avatarUrl : '/images/default-avatar.png'}"
                                 alt="avatar"
                                 width="40" height="40">
                        </a>

                    </td>
                    <td th:text="${u.fullName}">T√™n</td>
                    <td th:text="${u.email}">Email</td>
                    <td th:text="${u.phone}">SƒêT</td>
                    <td th:text="${u.role.roleName}">Vai tr√≤</td>
                    <td>
                          <span th:classappend="${u.status=='ACTIVE' ? 'status-active':'status-locked'}"
                                th:text="${u.status}">Tr·∫°ng th√°i</span>
                    </td>
                    <td th:text="${#temporals.format(u.createdAt, 'yyyy-MM-dd')}">Ng√†y</td>
                    <td style="text-align:right">
                        <!-- N√∫t kh√≥a / m·ªü -->
                        <form th:action="@{'/admin/users/' + ${u.userId} + '/toggle-status'}"
                              method="post" style="display:inline;">
                            <button type="submit"
                                    class="btn btn-sm"
                                    th:classappend="${u.status.name() == 'ACTIVE'} ? ' btn-pink' : ' btn-green'"
                                    th:text="${u.status.name() == 'ACTIVE'} ? 'Kh√≥a' : 'M·ªü'"
                            >
                            </button>
                        </form>

                        <!-- N√∫t x√≥a -->
                        <form th:action="@{'/admin/users/' + ${u.userId} + '/delete'}"
                              method="post"
                              style="display:inline;">
                            <button type="submit" class="btn btn-sm btn-danger">X√≥a</button>
                        </form>
                    </td>

                </tr>

                </tbody>
            </table>
        </div>

        <!-- Ph√¢n trang -->
        <div class="pagination">
            <div class="pagination-info">
                <span th:text="'T·ªïng '+${filteredUsers}+' k·∫øt qu·∫£'"></span>
                <select id="pageSizeSelect"
                        onchange="location.href=this.options[this.selectedIndex].dataset.href">
                    <option th:each="s : ${pageSizes}"
                            th:value="${s}"
                            th:text="${s}"
                            th:selected="${s == size}"
                            th:attr="data-href=@{/admin/users(
                keyword=${keyword}, roleId=${roleId}, status=${status},
                fromDate=${fromDate}, toDate=${toDate},
                sortField=${sortField}, sortDir=${sortDir},
                page=0, size=${s}
            )}">
                    </option>
                </select>
            </div>

            <div class="pagination-buttons">
                <a class="btn"
                   th:if="${page > 0}"
                   th:href="@{/admin/users(
    keyword=${keyword}, roleId=${roleId}, status=${status},
    fromDate=${fromDate}, toDate=${toDate},
    sortField=${sortField}, sortDir=${sortDir},
    page=${page > 0 ? page - 1 : 0}, size=${size}
)}"
                >¬´ </a>
                <span>Trang <span th:text="${page != null ? page + 1 : 1}"></span></span>

                <a class="btn"
                   th:if="${(page?:0 + 1) * (size?:10) < (filteredUsers?:0)}"
                   th:href="@{/admin/users(
         keyword=${keyword}, roleId=${roleId}, status=${status},
         fromDate=${fromDate}, toDate=${toDate},
         sortField=${sortField}, sortDir=${sortDir},
         page=${page+1}, size=${size}
       )}">¬ª</a>
            </div>
        </div>
    </main>
</div>


<!-- Modal: Th√™m ng∆∞·ªùi d√πng (tab Nh·∫≠p tay / T·∫£i h√†ng lo·∫°t) -->
<div class="modal" id="addUserModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Th√™m ng∆∞·ªùi d√πng m·ªõi</h2>

            <button class="modal-close" data-close="addUserModal">√ó</button>
        </div>
        <div class="modal-body">
            <div class="tabs" id="addUserTabs">
                <button class="tab active" data-tab="manual">Nh·∫≠p tay</button>
                <button class="tab" data-tab="bulk">T·∫£i l√™n h√†ng lo·∫°t</button>
            </div>

            <!-- Nh·∫≠p tay -->
            <form th:action="@{/admin/users/create}" method="post" id="addUserForm" data-tab-panel="manual">
                <div class="form-grid">
                    <div class="form-group">
                        <label>H·ªç t√™n *</label>
                        <div class="input-wrapper">
                            <input id="fullName" name="fullName" required>
                            <span class="validate-icon"></span>
                        </div>
                        <small class="error-text"></small>
                    </div>

                    <div class="form-group">
                        <label>Email *</label>
                        <div class="input-wrapper">
                            <input id="email" name="email" type="email" required>
                            <span class="validate-icon"></span>
                        </div>
                        <small class="error-text"></small>
                    </div>
                    <div class="form-group">
                        <label>M·∫≠t kh·∫©u *</label>
                        <div class="input-wrapper">
                            <input id="password" name="passwordHash" type="password" required>
                            <span class="validate-icon"></span>
                        </div>
                        <small class="error-text"></small>
                    </div>
                    <div class="form-group">
                        <label>S·ªë ƒëi·ªán tho·∫°i *</label>
                        <div class="input-wrapper">
                            <input id="phone" name="phone" type="tel">
                            <span class="validate-icon"></span>
                        </div>
                        <small class="error-text"></small>
                    </div>
                    <div class="form-group"><label>Vai tr√≤ *</label>
                        <select id="roleId" name="role.roleId" required>
                            <option value="">-- Ch·ªçn vai tr√≤ --</option>
                            <option th:each="r: ${roles}" th:value="${r.roleId}" th:text="${r.roleName}"></option>
                        </select>
                    </div>
                    <div class="form-group">

                        <div class="avatar-upload">
                            <!-- ·∫¢nh preview -->
                            <img id="avatarPreview" src="/images/default.png" alt="Avatar m·∫∑c ƒë·ªãnh">

                            <!-- Input upload ·∫£nh -->
                            <input type="file" id="avatarFile" name="avatarFile" accept="image/*" style="display:none;">
                            <button type="button" class="btn btn-outline" id="btnChooseAvatar">Ch·ªçn ·∫£nh</button>
                            <label>Avatar (kh√¥ng b·∫Øt bu·ªôc)</label>
                            <!-- Gi·ªØ URL ·∫£nh m·∫∑c ƒë·ªãnh (ho·∫∑c ·∫£nh ƒë√£ upload) ƒë·ªÉ g·ª≠i v·ªÅ backend -->
                            <input type="hidden" id="avatarUrl" name="avatarUrl" value="/images/default-avatar.png">
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label>ƒê·ªãa ch·ªâ</label>
                        <div class="address-group">
                            <select id="citySelect" name="citySelect" required>
                                <option value="">-- Ch·ªçn T·ªânh/Th√†nh ph·ªë --</option>
                            </select>
                            <select id="districtSelect" name="districtSelect" disabled required>
                                <option value="">-- Ch·ªçn Qu·∫≠n/Huy·ªán --</option>
                            </select>
                            <select id="wardSelect" name="wardSelect" disabled required>
                                <option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" data-close="addUserModal">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">T·∫°o t√†i kho·∫£n</button>
                </div>
            </form>

            <!-- Bulk -->
            <div id="bulkUploadPanel" class="bulk-panel" data-tab-panel="bulk" style="display:none">
                <div class="note-box">
                    <h4>Y√™u c·∫ßu file Excel</h4>
                    <ul>
                        <li>ƒê·ªãnh d·∫°ng: <strong>.xlsx</strong></li>
                        <li>C·ªôt: <strong>Email, H·ªç t√™n, SƒêT, Vai tr√≤</strong></li>
                        <li>Vai tr√≤ h·ª£p l·ªá: Admin / Qu·∫£n l√Ω / Nh√¢n vi√™n</li>
                        <li>Email tr√πng s·∫Ω b·ªã b·ªè qua v√† b√°o c√°o</li>
                        <li>T·ªëi ƒëa 1000 t√†i kho·∫£n/l·∫ßn</li>
                    </ul>
                    <a class="btn btn-outline" href="/admin/users/bulk/template" download>‚¨á T·∫£i m·∫´u Excel</a>
                </div>
                <div class="dropzone" id="bulkDropzone">
                    <input type="file" id="bulkFile" accept=".xlsx" hidden/>
                    <div class="dz-icon">üìÑ</div>
                    <p>K√©o th·∫£ file Excel v√†o ƒë√¢y ho·∫∑c</p>
                    <button type="button" class="btn btn-primary" id="btnChooseBulk">Ch·ªçn file</button>
                    <div id="bulkFilename" class="muted mt-8"></div>
                </div>
                <div class="modal-footer" style="padding-left:0">
                    <button type="button" class="btn btn-outline" data-close="addUserModal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" id="btnUploadBulk" disabled>T·∫£i l√™n</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Chi ti·∫øt ng∆∞·ªùi d√πng + ƒê√°nh gi√° sao -->
<!-- Modal Chi ti·∫øt ng∆∞·ªùi d√πng -->
<div class="modal" id="userDetailModal"
     th:classappend="${showUserDetailModal} ? ' show'">
    <div class="modal-content user-detail-modal">
        <div class="modal-header">
            <h2>Chi ti·∫øt ng∆∞·ªùi d√πng</h2>
            <a th:href="@{/admin/users}" class="modal-close">√ó</a>
        </div>

        <div class="modal-body user-detail-body" th:if="${selectedUser != null}">
            <div class="user-detail-left">
                <img th:src="${selectedUser.avatarUrl != null ? selectedUser.avatarUrl : '/images/default-avatar.png'}"
                     alt="Avatar ng∆∞·ªùi d√πng" class="user-avatar-large">
            </div>

            <div class="user-detail-right">
                <h2 th:text="${selectedUser.fullName}">T√™n ng∆∞·ªùi d√πng</h2>
                <p><strong>Vai tr√≤:</strong> <span th:text="${selectedUser.role.roleName}"></span></p>
                <p><strong>Email:</strong> <span th:text="${selectedUser.email}"></span></p>
                <p><strong>SƒêT:</strong> <span
                        th:text="${selectedUser.phone != null ? selectedUser.phone : '(Ch∆∞a c√≥)'}"></span></p>
                <p><strong>ƒê·ªãa ch·ªâ:</strong> <span
                        th:text="${selectedUser.address != null ? selectedUser.address : '(Ch∆∞a c·∫≠p nh·∫≠t)'}"></span></p>
                <p><strong>Tr·∫°ng th√°i:</strong>
                    <span th:classappend="${selectedUser.status == 'ACTIVE'} ? 'status-active' : 'status-locked'"
                          th:text="${selectedUser.status}"></span>
                </p>
                <p><strong>Ng√†y t·∫°o:</strong>
                    <span th:text="${#temporals.format(selectedUser.createdAt, 'dd/MM/yyyy')}"></span>
                </p>

                <div class="detail-actions">
                    <a th:href="@{'/admin/users/export/excel/' + ${selectedUser.userId}}" class="btn btn-outline">‚¨á Xu·∫•t
                        Excel</a>
                </div>
            </div>
        </div>
    </div>
</div>


<script th:src="@{/js/jsUser.js}"></script>
</body>
</html>
