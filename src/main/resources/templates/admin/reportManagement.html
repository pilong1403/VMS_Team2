<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>B√°o c√°o</title>
    <link rel="stylesheet" th:href="@{/css/styleUser.css}" />
</head>
<body data-page="reports">

<aside class="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-logo">
            <div class="logo-icon">üìä</div>
            <div class="logo-text">
                <h2>Qu·∫£n L√Ω Admin</h2>
                <p>H·ªá th·ªëng qu·∫£n tr·ªã</p>
            </div>
        </div>
    </div>
    <nav class="sidebar-nav">
        <div class="nav-label">MENU CH√çNH</div>
        <ul class="nav-menu">
            <li><a th:href="@{/admin/users}" class="nav-item">Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</a></li>
            <li><a th:href="@{/admin/organizations}" class="nav-item">H·ªì s∆° t·ªï ch·ª©c</a></li>
            <li><a th:href="@{/admin/reports}" class="nav-item active">B√°o c√°o</a></li>
        </ul>
    </nav>
</aside>

<div class="main-wrapper">
    <header class="header">
        <div class="header-title">B√°o c√°o & Th·ªëng k√™</div>
    </header>

    <main class="content">
        <div class="page-header">
            <h1>B√°o c√°o</h1>
            <p>Th·ªëng k√™ h·ªá th·ªëng theo th·ªùi gian</p>
        </div>

        <!-- ====== FORM L·ªåC B√ÅO C√ÅO ====== -->
        <form th:action="@{/admin/reports}" method="get" class="search-filter-bar">
            <div class="filter-group">
                <select name="rangeType">
                    <option value="week" th:selected="${rangeType == 'week'}">Tu·∫ßn</option>
                    <option value="month" th:selected="${rangeType == 'month'}">Th√°ng</option>
                    <option value="year" th:selected="${rangeType == 'year'}">NƒÉm</option>
                </select>

                <input type="date" name="fromDate" th:value="${fromDate}" />
                <input type="date" name="toDate" th:value="${toDate}" />

                <select name="sort">
                    <option value="desc" th:selected="${sort == 'desc'}">M·ªõi nh·∫•t</option>
                    <option value="asc" th:selected="${sort == 'asc'}">C≈© nh·∫•t</option>
                </select>

                <button type="submit" class="btn btn-outline">L·ªçc</button>
            </div>

            <div class="search-wrapper">
                <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                    <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                </svg>
                <input type="search" placeholder="T√¨m theo t√™n/email..." />
            </div>
        </form>

        <!-- ====== BI·ªÇU ƒê·ªí ====== -->
        <div class="card">
            <div class="card-header"><h3>Bi·ªÉu ƒë·ªì ng∆∞·ªùi d√πng ƒëƒÉng k√Ω</h3></div>
            <canvas id="userChart" height="180"></canvas>
        </div>

        <div class="card">
            <div class="card-header"><h3>Ph√¢n b·ªë ng∆∞·ªùi d√πng theo vai tr√≤</h3></div>
            <canvas id="roleChart" height="180"></canvas>
        </div>

        <!-- ====== B·∫¢NG D·ªÆ LI·ªÜU T·ªîNG H·ª¢P (n·∫øu c·∫ßn th√™m th·ªëng k√™ chi ti·∫øt) ====== -->
        <div class="table-wrapper">
            <table>
                <thead>
                <tr>
                    <th>T√™n</th>
                    <th>Email</th>
                    <th>Ng√†y t·∫°o</th>
                    <th>Tr·∫°ng th√°i</th>
                </tr>
                </thead>
                <tbody id="reportTableBody">
                <tr th:if="${userStats.labels == null or userStats.labels.size() == 0}">
                    <td colspan="4" class="muted">Kh√¥ng c√≥ d·ªØ li·ªáu trong kho·∫£ng th·ªùi gian n√†y.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </main>
</div>

<div class="toast" id="toast">
    <div class="toast-content">
        <strong id="toastTitle"></strong>
        <p id="toastMessage"></p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<!-- ====== BI·ªÇU ƒê·ªí JS (Thymeleaf inline data) ====== -->
<script th:inline="javascript">
    /*<![CDATA[*/
    const userLabels = /*[[${userStats.labels}]]*/ [];
    const userCounts = /*[[${userStats.counts}]]*/ [];
    const roleData = /*[[${roleDistribution}]]*/ {};
    const roleLabels = Object.keys(roleData);
    const roleCounts = Object.values(roleData);

    // Bi·ªÉu ƒë·ªì ng∆∞·ªùi d√πng ƒëƒÉng k√Ω (c·ªôt)
    new Chart(document.getElementById('userChart'), {
        type: 'bar',
        data: {
            labels: userLabels,
            datasets: [{
                label: 'S·ªë l∆∞·ª£ng ng∆∞·ªùi d√πng ƒëƒÉng k√Ω',
                data: userCounts,
                backgroundColor: '#007bff'
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });

    // Bi·ªÉu ƒë·ªì vai tr√≤ ng∆∞·ªùi d√πng (tr√≤n)
    new Chart(document.getElementById('roleChart'), {
        type: 'pie',
        data: {
            labels: roleLabels,
            datasets: [{
                data: roleCounts,
                backgroundColor: ['#007bff','#ffc107','#28a745','#dc3545','#17a2b8']
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'right' } }
        }
    });
    /*]]>*/
</script>

</body>
</html>
