<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>B√°o c√°o</title>
    <link rel="stylesheet" th:href="@{/css/styleUser.css}" />
</head>
<body data-page="reports">

<!--<aside class="sidebar">-->
<!--    <div class="sidebar-header">-->
<!--        <div class="sidebar-logo">-->
<!--            <div class="logo-icon">üìä</div>-->
<!--            <div class="logo-text">-->
<!--                <h2>Qu·∫£n L√Ω Admin</h2>-->
<!--                <p>H·ªá th·ªëng qu·∫£n tr·ªã</p>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
<!--    <nav class="sidebar-nav">-->
<!--        <div class="nav-label">MENU CH√çNH</div>-->
<!--        <ul class="nav-menu">-->
<!--            <li><a th:href="@{/admin/users}" class="nav-item">Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</a></li>-->
<!--            <li><a th:href="@{/admin/organizations}" class="nav-item">H·ªì s∆° t·ªï ch·ª©c</a></li>-->
<!--            <li><a th:href="@{/admin/reports}" class="nav-item active">B√°o c√°o</a></li>-->
<!--        </ul>-->
<!--    </nav>-->
<!--</aside>-->
<div th:replace="~{admin/fragments/sidebar :: sidebar}"></div>


<div class="main-wrapper">
    <header >
        <div th:replace="~{admin/fragments/header :: header}"></div>
    </header>

    <main class="content">
        <div class="page-header">
            <h1>B√°o c√°o</h1>
            <p>Th·ªëng k√™ h·ªá th·ªëng theo th·ªùi gian</p>
        </div>

        <!-- ====== FORM L·ªåC B√ÅO C√ÅO ====== -->
        <form th:action="@{/admin/reports}" method="get" class="search-filter-bar">
            <div class="filter-group">
                <select name="rangeType">
                    <option value="week" th:selected="${rangeType == 'week'}">Tu·∫ßn</option>
                    <option value="month" th:selected="${rangeType == 'month'}">Th√°ng</option>
                    <option value="year" th:selected="${rangeType == 'year'}">NƒÉm</option>
                </select>

                <input type="date" name="fromDate" th:value="${fromDate}" />
                <input type="date" name="toDate" th:value="${toDate}" />

                <select name="sort">
                    <option value="desc" th:selected="${sort == 'desc'}">M·ªõi nh·∫•t</option>
                    <option value="asc" th:selected="${sort == 'asc'}">C≈© nh·∫•t</option>
                </select>

                <button type="submit" class="btn btn-outline">L·ªçc</button>
            </div>

            <div class="search-wrapper">

                <input type="search" placeholder="T√¨m theo t√™n/email..." />
            </div>
        </form>

        <!-- ====== BI·ªÇU ƒê·ªí ====== -->
        <div class="chart-row">
            <div class="card">
                <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
                    <h3>Bi·ªÉu ƒë·ªì ng∆∞·ªùi d√πng ƒëƒÉng k√Ω</h3>
                    <div>
                        <button id="btnBack" class="btn btn-outline" style="display:none" onclick="goBackChart()">‚¨Ö Quay l·∫°i</button>
                        <button class="btn-export" onclick="exportChartToExcel('user')">T·∫£i Excel</button>
                    </div>
                </div>
                <canvas id="userChartUser" height="200"></canvas>
            </div>
            <div class="card">
                <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
                    <h3>Ph√¢n b·ªë theo vai tr√≤</h3>
                    <button class="btn-export" onclick="exportChartToExcel('role')">T·∫£i Excel</button>
                </div>
                <canvas id="roleChart" height="200"></canvas>
            </div>
        </div>

        <!-- ====== B·∫¢NG D·ªÆ LI·ªÜU T·ªîNG H·ª¢P (n·∫øu c·∫ßn th√™m th·ªëng k√™ chi ti·∫øt) ====== -->
        <div class="table-wrapper">
            <table>
                <thead>
                <tr>
                    <th>T√™n</th>
                    <th>Email</th>
                    <th>Ng√†y t·∫°o</th>
                    <th>Tr·∫°ng th√°i</th>
                </tr>
                </thead>
                <tbody id="reportTableBody">
                <tr th:if="${userStats.labels == null or userStats.labels.size() == 0}">
                    <td colspan="4" class="muted">Kh√¥ng c√≥ d·ªØ li·ªáu trong kho·∫£ng th·ªùi gian n√†y.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </main>
</div>

<div class="toast" id="toast">
    <div class="toast-content">
        <strong id="toastTitle"></strong>
        <p id="toastMessage"></p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<!-- ====== BI·ªÇU ƒê·ªí JS (Thymeleaf inline data) ====== -->
<script th:inline="javascript">
    /*<![CDATA[*/

    // ===== D·ªÆ LI·ªÜU T·ª™ BACKEND (Thymeleaf render) =====
    const userLabels = /*[[${userStats.labels}]]*/ [];
    const userCounts = /*[[${userStats.counts}]]*/ [];
    const roleData = /*[[${roleDistribution}]]*/ {};
    let currentRange = /*[[${rangeType}]]*/ 'month';

    // ===== V·∫º BI·ªÇU ƒê·ªí TR√íN (ROLE) =====
    const ctxRole = document.getElementById('roleChart');
    new Chart(ctxRole, {
        type: 'pie',
        data: {
            labels: Object.keys(roleData),
            datasets: [{
                data: Object.values(roleData),
                backgroundColor: ['#007bff','#ffc107','#28a745','#dc3545','#17a2b8']
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'right' } }
        }
    });

    // ===== V·∫º BI·ªÇU ƒê·ªí C·ªòT (USER) =====
    let userChart;
    const ctxUser = document.getElementById('userChartUser');

    // Stack ƒë·ªÉ l∆∞u l·ªãch s·ª≠ drilldown (quay l·∫°i)
    const drillStack = [];

    function renderUserChart(labels, counts) {
        if (userChart) userChart.destroy();
        userChart = new Chart(ctxUser, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'S·ªë l∆∞·ª£ng ng∆∞·ªùi d√πng ƒëƒÉng k√Ω',
                    data: counts,
                    backgroundColor: '#007bff'
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true } },
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: true }
                },
                // ======= CLICK TR√äN C·ªòT ƒê·ªÇ DRILLDOWN =======
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const label = labels[index];
                        drillDown(label);
                    }
                }
            }
        });
    }

    // render chart l·∫ßn ƒë·∫ßu
    renderUserChart(userLabels, userCounts);

    // ======= DRILLDOWN API CALL =======
    function drillDown(label) {
        // l∆∞u tr·∫°ng th√°i hi·ªán t·∫°i ƒë·ªÉ quay l·∫°i
        drillStack.push({
            labels: userChart.data.labels.slice(),
            counts: userChart.data.datasets[0].data.slice(),
            range: currentRange
        });

        document.getElementById('btnBack').style.display = 'inline-block';

        fetch(`/admin/reports/drilldown?rangeType=${currentRange}&label=${encodeURIComponent(label)}`)
            .then(res => res.json())
            .then(data => {
                if (data && data.labels && data.counts) {
                    currentRange = data.rangeType;
                    renderUserChart(data.labels, data.counts);
                } else {
                    showToast("Kh√¥ng c√≥ d·ªØ li·ªáu chi ti·∫øt.", "Th√¥ng b√°o");
                }
            })
            .catch(err => console.error("Drilldown error:", err));
    }

    // ======= N√öT QUAY L·∫†I =======
    function goBackChart() {
        const prev = drillStack.pop();
        if (prev) {
            renderUserChart(prev.labels, prev.counts);
            currentRange = prev.range;
        }
        if (drillStack.length === 0) {
            document.getElementById('btnBack').style.display = 'none';
        }
    }

    // ======= HI·ªÇN TH·ªä TOAST NG·∫ÆN =======
    function showToast(message, title="Th√¥ng b√°o") {
        const toast = document.getElementById('toast');
        const toastTitle = document.getElementById('toastTitle');
        const toastMessage = document.getElementById('toastMessage');
        toastTitle.innerText = title;
        toastMessage.innerText = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2500);
    }
    // ======= XU·∫§T EXCEL =======
        function exportChartToExcel(type) {
        const params = new URLSearchParams();
        params.append("type", type);
        params.append("rangeType", currentRange);

        const from = document.querySelector('input[name="fromDate"]').value;
        const to = document.querySelector('input[name="toDate"]').value;
        if (from) params.append("fromDate", from);
        if (to) params.append("toDate", to);

        // G·ªçi server backend ƒë·ªÉ t·∫£i Excel
        window.location.href = `/admin/reports/export?${params.toString()}`;
    }

    // header profile
    document.addEventListener('DOMContentLoaded', function () {
        const profileDropdown = document.getElementById('profileDropdown');
        const dropdownMenu = document.getElementById('dropdownMenu');

        if (profileDropdown) {
            profileDropdown.addEventListener('click', function (event) {
                event.stopPropagation(); // NgƒÉn s·ª± ki·ªán click lan ra ngo√†i
                dropdownMenu.classList.toggle('show');
            });
        }

        // ƒê√≥ng dropdown khi click ra ngo√†i
        window.addEventListener('click', function (event) {
            if (dropdownMenu && dropdownMenu.classList.contains('show')) {
                dropdownMenu.classList.remove('show');
            }
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
        const sidebarProfile = document.getElementById('sidebarProfile');
        const sidebarDropdownMenu = document.getElementById('sidebarDropdownMenu');

        if (sidebarProfile) {
            sidebarProfile.addEventListener('click', function (event) {
                event.stopPropagation();
                sidebarDropdownMenu.classList.toggle('show');
            });
        }

        // ƒê√≥ng dropdown khi click ra ngo√†i
        window.addEventListener('click', function (event) {
            if (sidebarDropdownMenu && sidebarDropdownMenu.classList.contains('show')) {
                sidebarDropdownMenu.classList.remove('show');
            }
        });
    });

    /*]]>*/
</script>


</body>
</html>
