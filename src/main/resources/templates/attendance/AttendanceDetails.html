<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/attendance/styleAttendDetails.css}"/>
    <title>Điểm Danh - Hệ Thống Quản Lý Tình Nguyện</title>
</head>

<body>
<div class="main-container">
            <div th:replace="~{fragments/organization/sidebar :: sidebar}"></div>

        <div class="content-wrapper">
            <div th:replace="~{fragments/organization/header :: header}"></div>


        <main class="main-content">

            <a th:href="@{/organization/attendance}" class="back-link">
                <i class="fa-solid fa-arrow-left"></i> Quay về trang quản lý điểm danh
            </a>

            <div class="page-header">
                <h1 class="page-title">Điểm Danh</h1>
                <p class="page-subtitle">Theo dõi sự tham gia và số giờ của tình nguyện viên</p>
            </div>

            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-info">
                        <div class="stat-label">Tổng Số Giờ</div>
                        <div class="stat-value" th:text="${totalHours} + 'h'">16.5</div>
                    </div>
                    <div class="stat-icon clock"><i class="fa-solid fa-clock"></i></div>
                </div>

                <div class="stat-card">
                    <div class="stat-info">
                        <div class="stat-label">Có Mặt</div>
                        <div class="stat-value" th:text="${presentCount}">3</div>
                    </div>
                    <div class="stat-icon check">✓</div>
                </div>

                <div class="stat-card">
                    <div class="stat-info">
                        <div class="stat-label">Vắng Mặt</div>
                        <div class="stat-value" th:text="${absentCount}">1</div>
                    </div>
                    <div class="stat-icon close">✕</div>
                </div>

                <div class="stat-card">
                    <div class="stat-info">
                        <div class="stat-label">Tỷ Lệ Hoàn Thành</div>
                        <div class="stat-value" th:text="${completeStatistic} + '%'">36%</div>
                    </div>
                    <div class="stat-icon percent">
                        <i class="fa-solid fa-users"></i>
                    </div>

                </div>
            </div>

            <div class="records-section">
                <h2 class="section-header" th:text="'Bảng điểm danh - ' + ${opportunity.getTitle()}">Bảng Điểm Danh</h2>

                <div class="filters-row">
                    <!-- Tìm kiếm -->
                    <div class="search-box">
                        <form th:action="@{/organization/attendance-details}" method="get">
                            <input type="hidden" name="opportunityId" th:value="${opportunity.oppId}">

                            <input type="hidden" name="status" th:value="${status}">
                            <input type="hidden" name="num" th:value="${num}">

                            <input type="text" id="searchInput" name="keyword"
                                   placeholder="Tìm kiếm theo tên, email"
                                   th:value="${keyword != null ? keyword : ''}"/>
                        </form>
                    </div>

                    <!-- lọc theo số bản ghi -->
                    <form method="get" th:action="@{/organization/attendance-details}">
                        <input type="hidden" name="opportunityId" th:value="${opportunity.oppId}">

                        <input type="hidden" name="status" th:value="${status}">
                        <input type="hidden" name="keyword" th:value="${keyword}">

                        <select class="filter-select" id="recordsFilter" name="num" onchange="this.form.submit()">
                            <option value="" th:selected="${num == null}" disabled>Hiển thị số bản ghi</option>
                            <option value="10" th:selected="${num == 10}">10</option>
                            <option value="20" th:selected="${num == 20}">20</option>
                            <option value="50" th:selected="${num == 50}">50</option>
                        </select>
                    </form>

                    <!-- lọc theo trạng thai -->
                    <form method="get" th:action="@{/organization/attendance-details}">
                        <input type="hidden" name="opportunityId" th:value="${opportunity.oppId}">

                        <input type="hidden" name="num" th:value="${num}">
                        <input type="hidden" name="keyword" th:value="${keyword}">

                        <select class="filter-select" id="statusFilter" name="status" onchange="this.form.submit()">
                            <option th:selected="${status == null or #strings.isEmpty(status)}" disabled>Lọc theo trạng thái</option>
                            <option value="pending" th:selected="${status == 'pending'}">Chưa điểm danh</option>
                            <option value="absent" th:selected="${status == 'absent'}">Vắng mặt</option>
                            <option value="present" th:selected="${status == 'present'}">Có mặt</option>
                            <option value="completed" th:selected="${status == 'completed'}">Hoàn thành</option>
                            <option value="all" th:selected="${status == 'all'}">Tất cả</option>
                        </select>
                    </form>


                </div>




                <table class="attendance-table">
                    <thead>
                    <tr>
                        <th>STT</th>
                        <th>Tình Nguyện Viên</th>
                        <th>Giờ Vào</th>
                        <th>Giờ Ra</th>
                        <th>Trạng Thái</th>
                        <th>Hành Động</th>
                    </tr>

                    <div id="error-alert" th:if="${error != null}" th:text="${error}"
                         style="background-color:#f8d7da; color:#842029; border:1px solid #f5c2c7;
                             padding:12px 18px; border-radius:6px; margin:10px 0; font-weight:bold;">
                    </div>

                    <div id="success-alert" th:if="${success != null}" th:text="${success}"
                         style="background-color:#d1e7dd; color:#0f5132; border:1px solid #badbcc;
                             padding:12px 18px; border-radius:6px; margin:10px 0; font-weight:bold;">
                    </div>


                    </thead>
                    <tbody id="attendanceTableBody">
                    <tr th:each="record, iterStat : ${attendanceList}">
                        <td th:text="${iterStat.count}">1</td>
                        <td>
                            <div class="volunteer-info">
                                <img th:src="${record.avatarUrl != null ? record.avatarUrl : '/images/default-avatar.png'}"
                                     th:alt="${record.fullName}"
                                     class="volunteer-avatar">
                                <div class="volunteer-details">
                                    <div class="volunteer-name" th:text="${record.fullName}">Nguyễn Thị Lan</div>
                                    <div class="volunteer-email" th:text="${record.email}">nguyen.lan@email.com</div>
                                </div>
                            </div>
                        </td>
                        <td class="time-cell"
                            th:text="${record.checkinTime != null ? #temporals.format(record.checkinTime, 'dd/MM/yyyy - HH:mm') : '--:--'}"></td>
                        <td class="time-cell"
                            th:text="${record.checkoutTime != null ? #temporals.format(record.checkoutTime, 'dd/MM/yyyy - HH:mm') : '--:--'}"></td>
                        <td>
                            <span th:switch="${record.status}"
                                  th:classappend="${record.status == 'COMPLETED' ? 'completed' : (record.status == 'PRESENT' ? 'present' : (record.status == 'ABSENT' ? 'absent' : 'pending'))}"
                                  class="status-badge">

                                <span th:case="'COMPLETED'">Hoàn thành</span>
                                <span th:case="'PRESENT'">Có mặt</span>
                                <span th:case="'ABSENT'">Vắng mặt</span>
                                <span th:case="*">Chưa điểm danh</span>
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons" th:switch="${statusOpp}">

                                <div th:case="'NOT_YET'">
                                    <button class="btn btn-ongoing" disabled>Sự kiện chưa diễn ra</button>
                                </div>

                                <div th:case="'HALF_CLOSED'">
                                    <button class="btn btn-checkin"
                                            th:data-application-id="${record.applicationId}"
                                            th:data-name="${record.fullName}"
                                            th:data-avatar="${record.avatarUrl != null ? record.avatarUrl : 'https://res.cloudinary.com/vmscloudinary/image/upload/v1760799914/images_i5lbsq.jpg'}"
                                            th:data-opp-id="${opportunity.oppId}"
                                            th:data-event-start-time="${opportunity.startTime != null ? #temporals.formatISO(opportunity.startTime) : ''}"
                                            th:data-event-end-time="${opportunity.endTime != null ? #temporals.formatISO(opportunity.endTime) : ''}"
                                            th:data-checkout-time="${record.checkoutTime != null ? #temporals.formatISO(record.checkoutTime) : ''}"
                                            onclick="openCheckinModal(this)">
                                        Check In
                                    </button>

                                    <button class="btn btn-checkout"
                                            th:data-application-id="${record.applicationId}"
                                            th:data-name="${record.fullName}"
                                            th:data-avatar="${record.avatarUrl != null ? record.avatarUrl : 'https://res.cloudinary.com/vmscloudinary/image/upload/v1760799914/images_i5lbsq.jpg'}"
                                            th:data-checkin-time="${record.checkinTime != null ? #temporals.formatISO(record.checkinTime) : ''}"
                                            th:data-event-start-time="${opportunity.startTime != null ? #temporals.formatISO(opportunity.startTime) : ''}"
                                            th:data-event-end-time="${opportunity.endTime != null ? #temporals.formatISO(opportunity.endTime) : ''}"
                                            th:data-opp-id="${opportunity.oppId}"
                                            th:disabled="${record.checkinTime == null}"
                                            onclick="openCheckOutModal(this)">
                                        Check Out
                                    </button>

                                    <button class="btn btn-detail"
                                            th:data-application-id="${record.applicationId}"
                                            th:data-name="${record.fullName}"
                                            th:data-opp-title="${opportunity.title}"
                                            th:data-opp-id="${opportunity.oppId}"
                                            th:data-phone-number="${record.phone}"
                                            th:data-address="${record.address}"
                                            th:data-checkin-time = "${record.checkinTime != null ? #temporals.format(record.checkinTime, 'dd/MM/yyyy - HH:mm') : '--:--'}"
                                            th:data-checkout-time = "${record.checkoutTime != null ? #temporals.format(record.checkoutTime, 'dd/MM/yyyy - HH:mm') : '--:--'}"
                                            th:data-status = "${record.status}"
                                            th:data-total-hours = "${record.totalHours}"
                                            th:data-note = "${record.notes}"
                                            th:data-proof-url = "${record.proofFileUrl}"
                                            onclick="openViewDetailModal(this)">
                                        Xem chi tiết
                                    </button>
                                </div>


                                <div th:case="'CLOSED'">
                                    <button class="btn btn-detail"
                                            th:data-application-id="${record.applicationId}"
                                            th:data-name="${record.fullName}"
                                            th:data-opp-title="${opportunity.title}"
                                            th:data-opp-id="${opportunity.oppId}"
                                            th:data-phone-number="${record.phone}"
                                            th:data-address="${record.address}"
                                            th:data-checkin-time = "${record.checkinTime != null ? #temporals.format(record.checkinTime, 'dd/MM/yyyy - HH:mm') : '--:--'}"
                                            th:data-checkout-time = "${record.checkoutTime != null ? #temporals.format(record.checkoutTime, 'dd/MM/yyyy - HH:mm') : '--:--'}"
                                            th:data-status = "${record.status}"
                                            th:data-total-hours = "${record.totalHours}"
                                            th:data-note = "${record.notes}"
                                            th:data-proof-url = "${record.proofFileUrl}"
                                            onclick="openViewDetailModal(this)">
                                        Xem chi tiết
                                    </button>
                                </div>

                                <div th:case="*">
                                    <button class="btn btn-checkin"
                                            th:data-application-id="${record.applicationId}"
                                            th:data-name="${record.fullName}"
                                            th:data-avatar="${record.avatarUrl != null ? record.avatarUrl : 'https://res.cloudinary.com/vmscloudinary/image/upload/v1760799914/images_i5lbsq.jpg'}"
                                            th:data-opp-id="${opportunity.oppId}"
                                            th:data-event-start-time="${opportunity.startTime != null ? #temporals.formatISO(opportunity.startTime) : ''}"
                                            th:data-event-end-time="${opportunity.endTime != null ? #temporals.formatISO(opportunity.endTime) : ''}"
                                            th:data-checkout-time="${record.checkoutTime != null ? #temporals.formatISO(record.checkoutTime) : ''}"
                                            onclick="openCheckinModal(this)">
                                        Check In
                                    </button>

                                    <button class="btn btn-checkout"
                                            th:data-application-id="${record.applicationId}"
                                            th:data-name="${record.fullName}"
                                            th:data-avatar="${record.avatarUrl != null ? record.avatarUrl : 'https://res.cloudinary.com/vmscloudinary/image/upload/v1760799914/images_i5lbsq.jpg'}"
                                            th:data-checkin-time="${record.checkinTime != null ? #temporals.formatISO(record.checkinTime) : ''}"
                                            th:data-event-start-time="${opportunity.startTime != null ? #temporals.formatISO(opportunity.startTime) : ''}"
                                            th:data-event-end-time="${opportunity.endTime != null ? #temporals.formatISO(opportunity.endTime) : ''}"
                                            th:data-opp-id="${opportunity.oppId}"
                                            th:disabled="${record.checkinTime == null}"
                                            onclick="openCheckOutModal(this)">
                                        Check Out
                                    </button>

                                    <button class="btn btn-detail"
                                            th:data-application-id="${record.applicationId}"
                                            th:data-name="${record.fullName}"
                                            th:data-opp-title="${opportunity.title}"
                                            th:data-opp-id="${opportunity.oppId}"
                                            th:data-phone-number="${record.phone}"
                                            th:data-address="${record.address}"
                                            th:data-checkin-time = "${record.checkinTime != null ? #temporals.format(record.checkinTime, 'dd/MM/yyyy - HH:mm') : '--:--'}"
                                            th:data-checkout-time = "${record.checkoutTime != null ? #temporals.format(record.checkoutTime, 'dd/MM/yyyy - HH:mm') : '--:--'}"
                                            th:data-status = "${record.status}"
                                            th:data-total-hours = "${record.totalHours}"
                                            th:data-note = "${record.notes}"
                                            th:data-proof-url = "${record.proofFileUrl}"
                                            onclick="openViewDetailModal(this)">
                                        Xem chi tiết
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>

            </div>



            <div class="pagination" th:if="${totalPages >= 1}">
                <button class="page-btn prev"
                        th:disabled="${currentPage == 1}"
                        th:onclick="|window.location.href='@{/organization/attendance-details(page=${currentPage - 1}, num=${num}, status=${status}, keyword=${keyword}, opportunityId=${opportunity.oppId})}'|">
                        &raquo;
                </button>

                <th:block th:if="${startPage > 2}">
                    <button class="page-btn"
                            th:onclick="|window.location.href='@{/organization/attendance-details(page=1, num=${num}, status=${status}, keyword=${keyword}, opportunityId=${opportunity.oppId})}'|">1</button>
                    <button class="page-btn" disabled>...</button>
                </th:block>

                <th:block th:each="i : ${#numbers.sequence(startPage, endPage)}">
                    <button class="page-btn"
                            th:text="${i}"
                            th:classappend="${i == currentPage} ? ' active' : ''"
                            th:onclick="|window.location.href='@{/organization/attendance-details(page=${i}, num=${num},status=${status}, keyword=${keyword}, opportunityId=${opportunity.oppId})}'|">
                    </button>
                </th:block>

                <th:block th:if="${(endPage + 1) < totalPages}">
                    <button class="page-btn" disabled>...</button>
                    <button class="page-btn"
                            th:onclick="|window.location.href='@{/organization/attendance-details(page=${totalPages}, num=${num},status=${status}, keyword=${keyword}, opportunityId=${opportunity.oppId})}'|">
                        [[${totalPages}]]
                    </button>
                </th:block>

                <button class="page-btn next"
                        th:disabled="${currentPage == totalPages}"
                        th:onclick="|window.location.href='@{/organization/attendance-details(page=${currentPage + 1}, num=${num},status=${status}, keyword=${keyword}, opportunityId=${opportunity.oppId})}'|">
                    &raquo;
                </button>
            </div>


        </main>
    </div>
</div>

<!--Modal Xác Nhận Điểm Danh CHECK IN-->
<div class="modal-overlay" id="attendanceModal">
    <div class="modal">
        <form id="checkinForm"
              method="POST"
              th:action="@{/organization/attendance-details/check-in}">

            <div class="modal-header">
                <h2 id="modalTitle">XÁC NHẬN CHECK IN</h2>
            </div>
            <div class="modal-body">
                <img src="https://i.pravatar.cc/150?u=sarah" alt="Avatar" class="modal-avatar" id="modalAvatar">
                <div class="volunteer-details">
                    <p>
                        Tình nguyện viên:
                        <span class="volunteer-name" id="modalVolunteerName">Nguyễn Thị Lan</span>
                    </p>
                    <p>Thời gian:</p>
                    <input type="datetime-local" id="modalTimeInput" name="checkinTime" required>
                </div>
            </div>
            <div class="modal-footer">
                <input type="hidden" id="applicationIdInput" name="applicationId">
                <input type="hidden" id="oppId" name="oppId">

                <button type="button" class="btn-cancel" id="cancelBtn" onclick="closeCheckModal()">Hủy</button>
                <button type="submit" class="btn-confirm" id="confirmBtn">Xác nhận</button>
            </div>
        </form>
    </div>
</div>


<!--Modal Xác Nhận Điểm Danh CHECK OUT-->
<div class="modal-overlay" id="attendanceModal2">
    <div class="modal">
        <form id="checkinForm2"
              method="POST"
              th:action="@{/organization/attendance-details/check-out}">

            <div class="modal-header">
                <h2 id="modalTitle2">XÁC NHẬN CHECK OUT</h2>
            </div>
            <div class="modal-body">
                <img src="https://i.pravatar.cc/150?u=sarah" alt="Avatar" class="modal-avatar" id="modalAvatar2">
                <div class="volunteer-details">
                    <p>
                        Tình nguyện viên:
                        <span class="volunteer-name" id="modalVolunteerName2">Nguyễn Thị Lan</span>
                    </p>
                    <p>Thời gian:</p>
                    <input type="datetime-local" id="modalTimeInput2" name="checkOutTime" required>
                </div>
            </div>
            <div class="modal-footer">
                <input type="hidden" id="applicationIdInput2" name="applicationId">
                <input type="hidden" id="oppIdOut" name="oppId">

                <button type="button" class="btn-cancel" id="cancelBtn2" onclick="closeCheckModal2()">Hủy</button>
                <button type="submit" class="btn-confirm" id="confirmBtn2">Xác nhận</button>
            </div>
        </form>
    </div>
</div>



<!--Modal Chi Tiết Điểm Danh -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <form id="detailsForm"
              method="POST"
              th:action="@{/organization/attendance-details/view-attendance-details}"
              enctype="multipart/form-data">

            <div class="modal-header">
                <h2 class="modal-title">Phiếu điểm danh</h2>
                <p class="modal-subtitle">Thông tin chi tiết điểm danh</p>
            </div>

            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Tên sự kiện <span class="readonly-text">(read only)</span> </label>
                        <div class="form-value" id="detailOppTitle"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Thời gian check in <span class="readonly-text">(read only)</span></label>
                        <div class="form-value" id="detailCheckinTime"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tên tình nguyện viên <span class="readonly-text">(read only)</span></label>
                        <div class="form-value" id="detailVolunteerName"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Thời gian check out <span class="readonly-text">(read only)</span></label>
                        <div class="form-value" id="detailCheckoutTime"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Số điện thoại <span class="readonly-text">(read only)</span></label>
                        <div class="form-value" id="detailPhone"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Địa chỉ <span class="readonly-text">(read only)</span></label>
                        <div class="form-value" id="detailAddress"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Trạng thái điểm danh <span class="readonly-text">(read only)</span></label>
                        <div id="detailStatusBadge"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tổng số giờ <span class="readonly-text">(read only)</span></label>
                        <div id="detailTotalHours"></div>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">Ghi chú</label>
                        <textarea id="detailNotes"  th:disabled="${statusOpp == 'CLOSED'}"
                                  name="notes" class="form-control" rows="6" placeholder="Nhập ghi chú...">
                        </textarea>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">Tải bằng chứng</label>
                        <div id="detailProofLinkContainer" style="margin-bottom: 8px;"></div>
                        <input type="file" th:disabled="${statusOpp == 'CLOSED'}"
                               class="form-input-file" id="detailProofFile" name="proofFile">
                    </div>

                </div>
            </div>

            <input type="hidden" id="applicationId" name="applicationId">
            <input type="hidden" id="oppId2" name="oppId">

            <div class="modal-footer" th:if="${statusOpp != 'CLOSED'}">
                <button type="button" class="btn-cancel" onclick="closeDetailModal()">Hủy</button>
                <button type="submit" class="btn-save">Lưu</button>
            </div>

        </form>
    </div>
</div>




<script th:src="@{/js/attendance/scriptAttendDetails.js}"></script>

<script>


    const autoHideAlert = (elementId, timeout) => {
        const alertElement = document.getElementById(elementId);
        if (alertElement) {
            setTimeout(() => {
                alertElement.style.display = 'none';
            }, timeout);
        }
    };

    autoHideAlert('error-alert', 5000);
    autoHideAlert('success-alert', 5000);


</script>

</body>

</html>