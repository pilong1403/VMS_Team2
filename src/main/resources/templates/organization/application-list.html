<!-- File: templates/organization/application-list.html -->
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <title>Danh sách đơn ứng tuyển</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        .card-stat {
            border: 1px solid #f1f1f1
        }

        .card-stat .value {
            font-size: 1.5rem;
            font-weight: 800
        }

        .search-bar .form-control {
            height: 42px
        }

        .table td,
        .table th {
            vertical-align: middle
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover
        }

        .btn-ghost {
            background: #f8f9fa;
            border: 1px solid #e9ecef
        }

        .badge-pill {
            border-radius: 9999px;
            padding: .35rem .65rem;
            font-weight: 600
        }

        .sticky-actions {
            white-space: nowrap
        }

        .search-bar .btn-filter {
            height: 42px;
            white-space: nowrap;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container py-4">

        <!-- Flash -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${success}">Thành công</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${error}">Có lỗi</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <h4 class="mb-3">Danh sách đơn ứng tuyển</h4>

        <!-- ===== Stats ===== -->
        <div class="row g-3 mb-3" th:if="${stats != null}">
            <div class="col-6 col-md-3" th:each="s : ${stats.entrySet()}">
                <div class="card card-stat shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="text-muted small" th:switch="${s.key}">
                                    <span th:case="'total'">Tổng số đơn</span>
                                    <span th:case="'pending'">Đang chờ</span>
                                    <span th:case="'approved'">Đã duyệt</span>
                                    <span th:case="'rejected'">Từ chối</span>
                                    <span th:case="'completed'">Hoàn thành</span>
                                    <span th:case="'cancelled'">Đã hủy</span>
                                    <span th:case="*" th:text="${s.key}">Khác</span>
                                </div>
                                <div class="value" th:text="${s.value}">0</div>
                            </div>
                            <div class="text-muted"><i class="bi bi-clipboard-check"></i></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== Filters ===== -->
        <form class="card shadow-sm mb-3 search-bar" method="get" th:action="@{|/organization/${orgId}/applications|}">
            <div class="card-body">
                <div class="row g-2 align-items-center">
                    <div class="col-12 col-md-5">
                        <input type="text" name="q" class="form-control"
                            placeholder="Tìm kiếm tình nguyện viên, cơ hội..." th:value="${param.q}" />
                    </div>

                    <!-- Filter trạng thái -->
                    <div class="col-6 col-md-2"
                        th:with="curStatus=${param.status != null && !#lists.isEmpty(param.status) ? param.status[0] : ''}">
                        <select class="form-select" name="status">
                            <option value="" th:selected="${curStatus == ''}">Tất cả trạng thái đơn</option>
                            <option value="PENDING" th:selected="${curStatus == 'PENDING'}">Đang chờ</option>
                            <option value="APPROVED" th:selected="${curStatus == 'APPROVED'}">Đã chấp nhận</option>
                            <option value="REJECTED" th:selected="${curStatus == 'REJECTED'}">Đã từ chối</option>
                            <option value="COMPLETED" th:selected="${curStatus == 'COMPLETED'}">Hoàn thành</option>
                            <option value="CANCELLED" th:selected="${curStatus == 'CANCELLED'}">Đã hủy</option>
                        </select>
                    </div>

                    <!-- Date range -->
                    <div class="col-6 col-md-2">
                        <input type="text" name="from" id="fromDate" class="form-control"
                            placeholder="Từ: ngày/tháng/năm"
                            th:value="${param.from != null ? param.from[0] : (fromStr ?: '')}" />
                    </div>
                    <div class="col-6 col-md-2">
                        <input type="text" name="to" id="toDate" class="form-control" placeholder="Đến: ngày/tháng/năm"
                            th:value="${param.to != null ? param.to[0] : (toStr ?: '')}" />
                    </div>

                    <input type="hidden" name="size" value="5" />

                    <div class="col-6 col-md-1">
                        <button class="btn btn-primary px-4" type="submit">Lọc</button>
                    </div>
                </div>
            </div>
        </form>

        <!-- ===== List ===== -->
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="fw-semibold">Tất cả đơn ứng tuyển</div>
                    <div class="text-muted small" th:text="'Tổng: ' + ${page.totalElements}">Tổng: 0</div>
                </div>

                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="min-width:260px">Tình nguyện viên</th>
                                <th style="width:30%">Cơ hội</th>
                                <th style="min-width:160px">Ngày ứng tuyển</th>
                                <th style="min-width:140px">Trạng thái</th>
                                <th class="text-end" style="min-width:220px">Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="row : ${page.content}">
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <img class="avatar" th:src="${#strings.isEmpty(row.volunteerAvatar) ?
                  'https://ui-avatars.com/api/?name=' + #uris.escapePath(row.volunteerName) :
                  row.volunteerAvatar}" alt="avatar" />
                                        <div class="fw-semibold" th:text="${row.volunteerName}">Nguyễn Thị Hoa</div>
                                    </div>
                                </td>

                                <td>
                                    <div class="fw-semibold" th:text="${row.opportunityTitle}">Dạy học miễn phí cho trẻ
                                        em vùng cao</div>
                                </td>

                                <td th:text="${#temporals.format(row.appliedAt, 'dd/MM/yyyy')}">01/01/2025</td>

                                <td
                                    th:with="st=${row.status}, ns=${st == null ? 'UNKNOWN' : #strings.toUpperCase(#strings.trim(st))}">
                                    <span class="badge badge-pill" th:classappend="${
                  #lists.contains({'PENDING','WAITING','PEND','PENDING_APPROVAL'}, ns) ? ' text-bg-secondary' :
                  (#lists.contains({'APPROVED','APPROVE','ACCEPTED'}, ns)             ? ' text-bg-primary'   :
                  (#lists.contains({'REJECTED','REJECT','DECLINED'}, ns)              ? ' text-bg-danger'    :
                  (#lists.contains({'COMPLETED','COMPLETE','DONE','FINISHED'}, ns)    ? ' text-bg-success'   :
                  (#lists.contains({'CANCELLED','CANCELED','CANCEL'}, ns)             ? ' text-bg-dark'      :
                                                                                         ' text-bg-light'))))}"
                                        th:text="${
                  #lists.contains({'PENDING','WAITING','PEND','PENDING_APPROVAL'}, ns) ? 'Đang chờ'    :
                  (#lists.contains({'APPROVED','APPROVE','ACCEPTED'}, ns)             ? 'Đã duyệt'    :
                  (#lists.contains({'REJECTED','REJECT','DECLINED'}, ns)              ? 'Từ chối'     :
                  (#lists.contains({'COMPLETED','COMPLETE','DONE','FINISHED'}, ns)    ? 'Hoàn thành' :
                  (#lists.contains({'CANCELLED','CANCELED','CANCEL'}, ns)             ? 'Đã hủy'      :
                                                                                        (st == null ? 'Khác' : st)))))}">
                                        Đang chờ
                                    </span>
                                </td>

                                <td class="text-end sticky-actions" th:with="st=${row.status}">
                                    <a class="btn btn-ghost btn-sm me-1"
                                        th:href="@{|/organization/${orgId}/applications/${row.appId}|}">
                                        Xem chi tiết
                                    </a>

                                    <!-- Chỉ hiện khi PENDING -->
                                    <th:block th:if="${#strings.equalsIgnoreCase(st,'PENDING')}">
                                        <button type="button" class="btn btn-sm btn-primary me-1 btn-open-review"
                                            data-bs-toggle="modal" data-bs-target="#reviewModal" data-action="approve"
                                            th:data-app-id="${row.appId}" th:data-vol-name="${row.volunteerName}"
                                            th:data-opp-title="${row.opportunityTitle}"
                                            th:data-applied-at="${#temporals.format(row.appliedAt, 'dd/MM/yyyy')}">
                                            Đồng ý
                                        </button>

                                        <button type="button" class="btn btn-sm btn-danger btn-open-review"
                                            data-bs-toggle="modal" data-bs-target="#reviewModal" data-action="reject"
                                            th:data-app-id="${row.appId}" th:data-vol-name="${row.volunteerName}"
                                            th:data-opp-title="${row.opportunityTitle}"
                                            th:data-applied-at="${#temporals.format(row.appliedAt, 'dd/MM/yyyy')}">
                                            Từ chối
                                        </button>
                                    </th:block>
                                </td>

                            </tr>

                            <tr th:if="${page == null or #lists.isEmpty(page.content)}">
                                <td colspan="5" class="text-center text-secondary py-4">
                                    Chưa có đơn ứng tuyển nào khớp bộ lọc.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ===== Pagination ===== -->
                <nav th:if="${page.totalPages > 1}" class="mt-2">
                    <ul class="pagination pagination-sm mb-0 justify-content-end">
                        <li class="page-item" th:classappend="${page.first} ? 'disabled'">
                            <a class="page-link" th:href="@{|/organization/${orgId}/applications|(q=${param.q},
              status=${param.status != null && !#lists.isEmpty(param.status) ? param.status[0] : ''},
              from=${param.from}, to=${param.to}, page=${page.number-1}, size=${page.size})}">
                                Trước
                            </a>
                        </li>

                        <li class="page-item" th:each="i : ${#numbers.sequence(0, page.totalPages-1)}"
                            th:classappend="${i == page.number} ? 'active'">
                            <a class="page-link" th:text="${i + 1}" th:href="@{|/organization/${orgId}/applications|(q=${param.q},
              status=${param.status != null && !#lists.isEmpty(param.status) ? param.status[0] : ''},
              from=${param.from}, to=${param.to}, page=${i}, size=${page.size})}">
                                1
                            </a>
                        </li>

                        <li class="page-item" th:classappend="${page.last} ? 'disabled'">
                            <a class="page-link" th:href="@{|/organization/${orgId}/applications|(q=${param.q},
              status=${param.status != null && !#lists.isEmpty(param.status) ? param.status[0] : ''},
              from=${param.from}, to=${param.to}, page=${page.number+1}, size=${page.size})}">
                                Sau
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <input type="hidden" id="baseAppUrl" th:value="@{|/organization/${orgId}/applications|}" />


    <!-- Init -->
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function () {
            // Khởi tạo date picker
            const fromVal = /*[[${param.from != null ? param.from[0] : ''}]]*/ '';
            const toVal = /*[[${param.to   != null ? param.to[0]   : ''}]]*/ '';
            flatpickr("#fromDate", { dateFormat: "d/m/Y", allowInput: true, defaultDate: fromVal || null });
            flatpickr("#toDate", { dateFormat: "d/m/Y", allowInput: true, defaultDate: toVal || null });

            // Modal logic
            const reviewForm = document.getElementById('reviewForm');
            const titleElm = document.getElementById('reviewModalTitle');
            const submitBtn = document.getElementById('reviewSubmitBtn');

            const volElm = document.getElementById('rv-vol-name');
            const oppElm = document.getElementById('rv-opp-title');
            const atElm = document.getElementById('rv-applied-at');
            const noteElm = document.getElementById('rv-note');

            const baseAppUrl = document.getElementById('baseAppUrl').value;

            // Gắn action động cho form theo nút bấm
            document.querySelectorAll('.btn-open-review').forEach(btn => {
                btn.addEventListener('click', () => {
                    const act = btn.getAttribute('data-action'); // 'approve' | 'reject'
                    const appId = btn.getAttribute('data-app-id');

                    // Fill thông tin hiển thị
                    volElm.textContent = btn.getAttribute('data-vol-name') || '—';
                    oppElm.textContent = btn.getAttribute('data-opp-title') || '—';
                    atElm.textContent = btn.getAttribute('data-applied-at') || '—';
                    noteElm.value = '';

                    if (act === 'approve') {
                        titleElm.textContent = 'Duyệt đơn ứng tuyển';
                        submitBtn.textContent = 'Duyệt';
                        submitBtn.classList.remove('btn-danger');
                        submitBtn.classList.add('btn-primary');
                        // /organization/{orgId}/applications/{appId}/approve
                        reviewForm.setAttribute('action', `${baseAppUrl}/${appId}/approve`);
                    } else {
                        titleElm.textContent = 'Từ chối đơn ứng tuyển';
                        submitBtn.textContent = 'Từ chối';
                        submitBtn.classList.remove('btn-primary');
                        submitBtn.classList.add('btn-danger');
                        // /organization/{orgId}/applications/{appId}/reject
                        reviewForm.setAttribute('action', `${baseAppUrl}/${appId}/reject`);
                    }
                });
            });

            // Chặn submit nếu vì lý do nào đó action chưa được set
            reviewForm.addEventListener('submit', (e) => {
                if (!reviewForm.getAttribute('action')) {
                    e.preventDefault();
                    alert('Không xác định được hành động. Vui lòng mở lại popup từ nút Đồng ý/Từ chối.');
                }
            });
        });
    </script>

    <!-- Review Modal -->
    <div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="reviewForm" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title" id="reviewModalTitle">Xử lý đơn</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">
                        <div class="mb-2">
                            <div class="small text-muted">Tình nguyện viên</div>
                            <div id="rv-vol-name" class="fw-semibold">—</div>
                        </div>
                        <div class="mb-2">
                            <div class="small text-muted">Cơ hội</div>
                            <div id="rv-opp-title" class="fw-semibold">—</div>
                        </div>
                        <div class="mb-3">
                            <div class="small text-muted">Ngày ứng tuyển</div>
                            <div id="rv-applied-at">—</div>
                        </div>

                        <div class="mb-3">
                            <label for="rv-note" class="form-label">Ghi chú</label>
                            <textarea id="rv-note" name="note" rows="3" class="form-control"
                                placeholder="Nhập ghi chú để xử lý đơn ứng tuyển (tuỳ chọn)"></textarea>
                        </div>

                        <!-- keep filters -->
                        <input type="hidden" name="q"
                            th:value="${param.q != null      && !#lists.isEmpty(param.q)      ? param.q[0]      : ''}" />
                        <input type="hidden" name="status"
                            th:value="${param.status != null && !#lists.isEmpty(param.status) ? param.status[0] : ''}" />
                        <input type="hidden" name="from"
                            th:value="${param.from != null   && !#lists.isEmpty(param.from)   ? param.from[0]   : fromStr}" />
                        <input type="hidden" name="to"
                            th:value="${param.to   != null   && !#lists.isEmpty(param.to)     ? param.to[0]     : toStr}" />
                        <input type="hidden" name="page" th:value="${param.page}" />
                        <input type="hidden" name="size" th:value="${param.size}" />
                        <!-- CSRF -->
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-ghost" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" id="reviewSubmitBtn" class="btn btn-primary">Xác nhận</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</body>

</html>