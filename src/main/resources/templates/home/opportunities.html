<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{fragments/head :: head('Cơ Hội Tình Nguyện')}"></head>
  <body>
    <!-- Header -->
    <div th:replace="~{fragments/header :: header}"></div>

    <!-- Main Content -->
    <main>
      <!-- Hero Section -->
      <section class="cta-section py-5">
        <div class="container text-center py-4">
          <h1 class="display-4 fw-bold mb-3">Cơ Hội Tình Nguyện</h1>
          <p class="lead opacity-90">Khám phá và tham gia các hoạt động ý nghĩa</p>
        </div>
      </section>

      <!-- Main Layout -->
      <div class="container py-5">
        <div class="row g-4">
          <!-- Sidebar Filters (25%) -->
          <div class="col-3">
            <form id="filterForm">
              <div class="filter-sidebar bg-white rounded shadow p-4 sticky-top" style="top: 100px">
                <h5 class="fw-bold mb-4">Bộ Lọc</h5>

                <!-- Search -->
                <div class="mb-4">
                  <label class="form-label fw-semibold">Tìm kiếm</label>
                  <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input
                      type="text"
                      class="form-control"
                      name="search"
                      placeholder="Tìm kiếm cơ hội..."
                      th:value="${searchTerm}"
                    />
                  </div>
                </div>

                <!-- Categories -->
                <div class="mb-4">
                  <label class="form-label fw-semibold">Danh mục</label>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="category"
                      id="catAll"
                      value=""
                      th:checked="${selectedCategoryId == null}"
                    />
                    <label class="form-check-label" for="catAll">Tất cả</label>
                  </div>
                  <div class="form-check" th:each="category : ${categories}">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="category"
                      th:id="'cat' + ${category.categoryId}"
                      th:value="${category.categoryId}"
                      th:checked="${selectedCategoryId != null && selectedCategoryId == category.categoryId}"
                    />
                    <label
                      class="form-check-label"
                      th:for="'cat' + ${category.categoryId}"
                      th:text="${category.categoryName}"
                      >Category Name</label
                    >
                  </div>
                </div>

                <!-- Location -->
                <div class="mb-4">
                  <label class="form-label fw-semibold">Địa điểm</label>
                  <select class="form-select" name="location">
                    <option value="" th:selected="${selectedLocation == null}">Tất cả địa điểm</option>
                    <option value="Hà Nội" th:selected="${selectedLocation == 'Hà Nội'}">Hà Nội</option>
                    <option value="TP. Hồ Chí Minh" th:selected="${selectedLocation == 'TP. Hồ Chí Minh'}">
                      TP. Hồ Chí Minh
                    </option>
                    <option value="Đà Nẵng" th:selected="${selectedLocation == 'Đà Nẵng'}">Đà Nẵng</option>
                    <option value="Sapa" th:selected="${selectedLocation == 'Sapa'}">Sapa, Lào Cai</option>
                  </select>
                </div>

                <!-- Time -->
                <div class="mb-4">
                  <label class="form-label fw-semibold">Thời gian</label>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="time" id="today" />
                    <label class="form-check-label" for="today">Hôm nay</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="time" id="week" />
                    <label class="form-check-label" for="week">Tuần này</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="time" id="month" />
                    <label class="form-check-label" for="month">Tháng này</label>
                  </div>
                </div>

                <!-- Status -->
                <div class="mb-4">
                  <label class="form-label fw-semibold">Trạng thái</label>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="status"
                      id="statusAll"
                      value=""
                      th:checked="${selectedStatus == null}"
                    />
                    <label class="form-check-label" for="statusAll">Tất cả</label>
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="status"
                      id="open"
                      value="OPEN"
                      th:checked="${selectedStatus == 'OPEN'}"
                    />
                    <label class="form-check-label" for="open">Đang mở</label>
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="status"
                      id="closed"
                      value="CLOSED"
                      th:checked="${selectedStatus == 'CLOSED'}"
                    />
                    <label class="form-check-label" for="closed">Đã đóng</label>
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="status"
                      id="cancelled"
                      value="CANCELLED"
                      th:checked="${selectedStatus == 'CANCELLED'}"
                    />
                    <label class="form-check-label" for="cancelled">Đã hủy</label>
                  </div>
                </div>

                <!-- Action Buttons -->
                <div class="d-grid gap-2">
                  <button type="button" class="btn btn-primary-custom" onclick="applyFilters()">Áp Dụng</button>
                  <a href="/opportunities" class="text-muted text-center text-decoration-none">Xóa Bộ Lọc</a>
                </div>
              </div>
            </form>
          </div>

          <!-- Main Content (75%) -->
          <div class="col-9">
            <!-- Header with Sort -->
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h4 class="fw-bold" th:text="${totalElements} + ' Cơ Hội'">0 Cơ Hội</h4>
              <select class="form-select" name="sort" style="width: auto" onchange="applyFilters()">
                <option value="newest" th:selected="${sortBy == 'newest'}">Mới nhất</option>
                <option value="deadline" th:selected="${sortBy == 'deadline'}">Sắp kết thúc</option>
                <option value="popular" th:selected="${sortBy == 'popular'}">Nhiều người quan tâm</option>
              </select>
            </div>

            <!-- Opportunities Grid -->
            <div class="row g-4 mb-5" th:if="${opportunities != null and !opportunities.empty}">
              <!-- Dynamic Cards -->
              <div class="col-6" th:each="opp : ${opportunities}">
                <div class="project-card">
                  <div class="position-relative">
                    <img
                      th:src="${@templateUtils.getDefaultThumbnail(opp.thumbnailUrl)}"
                      class="card-img-top"
                      th:alt="${opp.title}"
                    />
                    <span class="badge position-absolute" style="top: 12px; left: 12px" th:text="${opp.categoryName}"
                      >Category</span
                    >
                    <span
                      class="badge position-absolute"
                      style="top: 12px; right: 12px"
                      th:class="'badge position-absolute ' + ${opp.statusBadgeClass}"
                      th:text="${opp.statusDisplayName}"
                      >Status</span
                    >
                  </div>
                  <div class="card-body p-4 d-flex flex-column">
                    <div class="flex-grow-1">
                      <div class="d-flex align-items-center gap-2 mb-2">
                        <span class="text-muted small" th:text="${opp.organizationName}">Organization</span>
                        <i class="bi bi-patch-check-fill text-primary" th:if="${opp.organizationVerified}"></i>
                      </div>
                      <h5 class="card-title fw-bold mb-2 line-clamp-2" th:text="${opp.title}">Title</h5>
                      <p class="text-muted small mb-3 line-clamp-2" th:text="${opp.subtitle}">Subtitle</p>

                      <div class="d-flex align-items-center gap-3 text-muted small mb-4">
                        <div class="d-flex align-items-center" th:if="${opp.location}">
                          <i class="bi bi-geo-alt me-1"></i>
                          <span th:text="${opp.location}">Location</span>
                        </div>
                        <!-- Thời gian: Start – End -->
                        <div class="d-flex align-items-center" th:if="${opp.startTime}">
                          <i class="bi bi-calendar me-1"></i>
                          <span th:text="${#temporals.format(opp.startTime, 'dd/MM/yyyy HH:mm')}">Start</span>
                          <span th:if="${opp.endTime}" class="mx-1">–</span>
                          <span th:if="${opp.endTime}" th:text="${#temporals.format(opp.endTime, 'dd/MM/yyyy HH:mm')}">End</span>
                        </div>

                      </div>
                    </div>

                    <div class="mt-auto">
                      <div class="mb-3">
                        <div class="d-flex justify-content-between small mb-2">
                          <span class="text-muted">Tình nguyện viên:</span>
                          <span
                            class="fw-semibold"
                            style="color: #38bdf8"
                            th:text="${opp.appliedVolunteers} + ' / ' + ${opp.neededVolunteers} + ' người'"
                            >0 / 0 người</span
                          >
                        </div>
                        <div class="progress progress-custom">
                          <div class="progress-bar" th:style="'width: ' + ${opp.progressPercentage} + '%'"></div>
                        </div>
                      </div>

                      <div class="d-flex gap-2">
                        <a
                          th:href="@{/opportunities/{id}(id=${opp.oppId})}"
                          class="btn btn-outline-primary-custom flex-fill"
                        >
                          <i class="bi bi-eye me-1"></i>Chi Tiết
                        </a>
                        <button class="btn btn-primary-custom flex-fill">
                          <i class="bi bi-person-plus me-1"></i>Đăng Ký
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Empty State -->
            <div class="text-center py-5" th:if="${opportunities == null or opportunities.empty}">
              <i class="bi bi-search display-1 text-muted mb-3"></i>
              <h4 class="text-muted">Không tìm thấy cơ hội nào</h4>
              <p class="text-muted">Thử thay đổi bộ lọc hoặc tìm kiếm với từ khóa khác</p>
            </div>

            <!-- Pagination -->
            <nav aria-label="Pagination" th:if="${totalPages > 1}">
              <ul class="pagination justify-content-center">
                <!-- Previous -->
                <li class="page-item" th:classappend="${!hasPrevious} ? 'disabled'">
                  <a
                    class="page-link"
                    th:href="@{/opportunities(page=${currentPage - 1}, size=6, categoryId=${selectedCategoryId}, location=${selectedLocation}, status=${selectedStatus}, search=${searchTerm}, sort=${sortBy})}"
                    aria-label="Previous"
                    th:if="${hasPrevious}"
                  >
                    <span aria-hidden="true">&laquo;</span>
                  </a>
                  <span class="page-link" th:unless="${hasPrevious}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                  </span>
                </li>

                <!-- Page Numbers -->
                <li
                  class="page-item"
                  th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                  th:if="${i >= (currentPage - 2) and i <= (currentPage + 2)}"
                  th:classappend="${i == currentPage} ? 'active'"
                >
                  <a
                    class="page-link"
                    th:href="@{/opportunities(page=${i}, size=6, categoryId=${selectedCategoryId}, location=${selectedLocation}, status=${selectedStatus}, search=${searchTerm}, sort=${sortBy})}"
                    th:style="${i == currentPage} ? 'background-color: #38bdf8; border-color: #38bdf8; color: white;' : ''"
                    th:text="${i + 1}"
                    >1</a
                  >
                </li>

                <!-- Next -->
                <li class="page-item" th:classappend="${!hasNext} ? 'disabled'">
                  <a
                    class="page-link"
                    th:href="@{/opportunities(page=${currentPage + 1}, size=6, categoryId=${selectedCategoryId}, location=${selectedLocation}, status=${selectedStatus}, search=${searchTerm}, sort=${sortBy})}"
                    aria-label="Next"
                    th:if="${hasNext}"
                  >
                    <span aria-hidden="true">&raquo;</span>
                  </a>
                  <span class="page-link" th:unless="${hasNext}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                  </span>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <div th:replace="~{fragments/footer :: footer}"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JS -->
    <script th:src="@{/js/opportunities.js}"></script>
  </body>
</html>
